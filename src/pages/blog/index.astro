---
import Layout from '../../layouts/Layout.astro';
---

<Layout 
  title="博客 - 个人空间"
  description="技术博客与学习笔记，分享编程经验和开发心得"
>
  <!-- 页面标题区 -->
  <section class="pt-32 pb-16">
    <div class="container-custom">
      <div class="text-center mb-4">
        <span class="text-sm font-medium text-gray-400 uppercase tracking-wider">思考</span>
      </div>
      <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold text-gray-900 text-center max-w-4xl mx-auto mb-6">
        最新洞察与日志
      </h1>
      <p class="text-lg text-gray-500 text-center max-w-2xl mx-auto">
        记录技术探索与思考，分享学习心得与实践经验。<br>
        在这里，你会找到关于AI开发、Web全栈技术和系统设计思考的文章。
      </p>

      <!--&lt;!&ndash; 当前分类提示 &ndash;&gt;-->
      <!--<div id="current-category" class="text-center mt-4 hidden">-->
      <!--  <span class="text-sm text-gray-500">-->
      <!--    正在查看分类：-->
      <!--    <span id="category-name" class="font-medium text-gray-700"></span>-->
      <!--  </span>-->
      <!--</div>-->
    </div>
  </section>

  <!-- 分类筛选 -->
  <section class="pb-12">
    <div class="container-custom">
      <div id="category-filters" class="flex flex-wrap items-center justify-center gap-3">
        <!-- 分类按钮将通过 JS 动态加载 -->
        <div class="h-10 w-16 bg-gray-200 rounded-full animate-pulse"></div>
        <div class="h-10 w-20 bg-gray-100 rounded-full animate-pulse"></div>
        <div class="h-10 w-24 bg-gray-100 rounded-full animate-pulse"></div>
      </div>
    </div>
  </section>

  <!-- 文章列表 -->
  <section class="pb-20">
    <div class="container-custom">
      <div id="posts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
        <!-- 骨架屏加载状态 -->
        {[1,2,3,4,5,6].map(() => (
          <div class="bg-white rounded-2xl p-6 border border-gray-100 animate-pulse">
            <div class="aspect-video bg-gray-100 rounded-lg -mx-6 -mt-6 mb-5"></div>
            <div class="flex gap-2 mb-3">
              <div class="h-6 w-16 bg-gray-100 rounded-full"></div>
            </div>
            <div class="h-6 bg-gray-100 rounded w-3/4 mb-2"></div>
            <div class="h-4 bg-gray-100 rounded w-full mb-1"></div>
            <div class="h-4 bg-gray-100 rounded w-2/3 mb-4"></div>
            <div class="h-4 bg-gray-100 rounded w-24"></div>
          </div>
        ))}
      </div>
      
      <!-- 加载更多按钮 -->
      <div id="load-more-container" class="text-center mt-12" style="display: none;">
        <button id="load-more-btn" class="inline-flex items-center gap-2 px-8 py-3 rounded-full text-base font-medium border border-gray-200 text-gray-700 hover:bg-gray-50 hover:border-gray-300 transition-all">
          加载更多文章
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
      </div>
    </div>
  </section>

  <!-- 订阅区域 -->
  <section class="py-20 bg-gray-50/50">
    <div class="container-custom">
      <div class="max-w-2xl mx-auto text-center">
        <h2 class="text-2xl lg:text-3xl font-bold text-gray-900 mb-4">
          订阅我们的通讯
        </h2>
        <p class="text-gray-500 mb-8">
          获取最新文章和洞察，直接发送到您的邮箱。
        </p>
        <form class="flex flex-col sm:flex-row gap-3 max-w-md mx-auto">
          <input 
            type="email" 
            placeholder="输入您的邮箱"
            class="flex-1 px-5 py-3 rounded-full border border-gray-200 focus:outline-none focus:border-gray-400 transition-colors"
          />
          <button 
            type="submit"
            class="inline-flex items-center justify-center gap-2 bg-dark-100 text-white px-6 py-3 rounded-full font-medium hover:bg-dark-300 transition-colors"
          >
            订阅
            <svg class="w-4 h-4 text-primary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </button>
        </form>
      </div>
    </div>
  </section>
</Layout>

<script is:inline>
  const POSTS_PER_PAGE = 6;
  const SANITY_PROJECT_ID = 'k2j30muc';
  const SANITY_DATASET = 'production';
  
  let posts = [];
  let categories = [];
  let currentPage = 1;
  let currentFilteredPosts = [];
  let selectedCategory = new URLSearchParams(window.location.search).get('category') || '';

  const categoryFilters = document.getElementById('category-filters');
  const postsGrid = document.getElementById('posts-grid');
  const loadMoreContainer = document.getElementById('load-more-container');
  const loadMoreBtn = document.getElementById('load-more-btn');

  // Sanity API 查询
  async function fetchSanity(query) {
    const url = `https://${SANITY_PROJECT_ID}.api.sanity.io/v2024-01-01/data/query/${SANITY_DATASET}?query=${encodeURIComponent(query)}`;
    const res = await fetch(url);
    const data = await res.json();
    return data.result;
  }

  // 生成文章卡片 HTML
  function createPostHtml(post) {
    const date = new Date(post.publishedAt).toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
    const cats = (post.categories || []).filter(c => c).slice(0, 2).map(c => 
      `<span class="inline-block px-2.5 py-1 bg-gray-100 rounded-full text-xs font-medium text-gray-600">${c.title}</span>`
    ).join('');
    
    return `<a href="/blog/${post.slug.current}" class="group overflow-hidden block">
      <div class="bg-white rounded-2xl p-6 border border-gray-100 hover:border-gray-200 hover:shadow-card transition-all">
        ${post.coverImage ? `<div class="relative -mx-6 -mt-6 mb-5 overflow-hidden"><div class="aspect-video bg-gray-50"><img src="${post.coverImage}" alt="${post.title}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" loading="lazy"/></div></div>` : ''}
        ${cats ? `<div class="flex flex-wrap gap-2 mb-3">${cats}</div>` : ''}
        <h3 class="text-lg font-semibold text-gray-900 mb-2 group-hover:text-gray-600 transition-colors">${post.title}</h3>
        <p class="text-gray-500 text-sm leading-relaxed mb-4 line-clamp-2">${post.excerpt || ''}</p>
        <div class="flex items-center text-sm text-gray-400"><svg class="w-4 h-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg><time datetime="${post.publishedAt}">${date}</time></div>
      </div>
    </a>`;
  }

  // 渲染分类按钮
  function renderCategories() {
    const allCats = [{ title: '全部', slug: '' }, ...categories.filter(c => c.slug).map(c => ({ title: c.title, slug: c.slug }))];
    categoryFilters.innerHTML = allCats.map(cat => {
      const isActive = cat.slug === selectedCategory;
      return `<button data-category="${cat.slug}" class="px-4 py-2 rounded-full text-sm font-medium transition-colors ${isActive ? 'bg-gray-900 text-white' : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'}">${cat.title}</button>`;
    }).join('');
  }

  // 筛选文章
  function filterByCategory(categorySlug) {
    selectedCategory = categorySlug;
    currentPage = 1;
    window.history.pushState({}, '', categorySlug ? `/blog?category=${categorySlug}` : '/blog');
    
    currentFilteredPosts = categorySlug 
      ? posts.filter(p => p.categories?.some(c => (c.slug?.current || c.slug) === categorySlug))
      : posts;
    
    const toShow = currentFilteredPosts.slice(0, POSTS_PER_PAGE);
    postsGrid.innerHTML = toShow.length ? toShow.map(createPostHtml).join('') : '<div class="col-span-full text-center py-12"><p class="text-gray-500">该分类下暂无博客文章</p></div>';
    loadMoreContainer.style.display = toShow.length < currentFilteredPosts.length ? 'block' : 'none';
    renderCategories();
  }

  // 加载更多
  function loadMore() {
    currentPage++;
    const newPosts = currentFilteredPosts.slice((currentPage - 1) * POSTS_PER_PAGE, currentPage * POSTS_PER_PAGE);
    postsGrid.insertAdjacentHTML('beforeend', newPosts.map(createPostHtml).join(''));
    if (currentPage * POSTS_PER_PAGE >= currentFilteredPosts.length) loadMoreContainer.style.display = 'none';
  }

  // 绑定事件
  categoryFilters.addEventListener('click', e => {
    const btn = e.target.closest('button');
    if (btn) filterByCategory(btn.dataset.category);
  });
  loadMoreBtn?.addEventListener('click', loadMore);

  // 异步加载数据
  async function loadData() {
    const postsQuery = `*[_type == "post"] | order(publishedAt desc) {
      _id, title, slug, excerpt, publishedAt,
      "coverImage": coverImage.asset->url,
      categories[]->{title, slug}
    }`;
    const categoriesQuery = `*[_type == "category"] | order(title asc) { _id, title, "slug": slug.current }`;
    
    [posts, categories] = await Promise.all([fetchSanity(postsQuery), fetchSanity(categoriesQuery)]);
    currentFilteredPosts = posts;
    
    renderCategories();
    filterByCategory(selectedCategory);
  }

  loadData();
</script>

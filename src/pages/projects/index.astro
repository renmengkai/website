---
import Layout from '../../layouts/Layout.astro';
---

<Layout 
  title="作品 - 个人空间"
  description="展示我参与或独立完成的项目作品"
>
  <!-- 页面标题区 -->
  <section class="pt-24 pb-6">
    <div class="container-custom">
      <div class="text-center mb-4">
        <span class="text-sm font-medium text-gray-400 uppercase tracking-wider">实践</span>
      </div>
      <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold text-gray-900 text-center max-w-4xl mx-auto mb-6">
        精选作品与项目
      </h1>
      <p class="text-md text-gray-500 text-center max-w-2xl mx-auto">
        展示我独立完成或参与的项目，从创意构思到技术实现的完整历程。<br>
        每个项目都是学习和成长的见证。
      </p>
    </div>
  </section>

  <!-- 搜索栏 -->
  <section class="pb-4 mt-2">
    <div class="container-custom">
      <div class="max-w-xl mx-auto">
        <div class="relative">
          <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input 
            type="text" 
            id="search-input"
            placeholder="搜索项目名称..."
            class="w-full pl-12 pr-4 py-3 rounded-full border border-gray-200 bg-white focus:outline-none focus:border-gray-400 focus:ring-2 focus:ring-gray-100 transition-all text-gray-700 placeholder-gray-400"
          />
        </div>
      </div>
    </div>
  </section>

  <!-- 分类筛选 -->
  <section class="pb-8">
    <div class="container-custom">
      <div id="category-filters" class="flex flex-wrap items-center justify-center gap-3">
        <!-- 分类按钮将通过 JS 动态加载 -->
        <div class="h-10 w-16 bg-gray-200 rounded-full animate-pulse"></div>
        <div class="h-10 w-20 bg-gray-100 rounded-full animate-pulse"></div>
        <div class="h-10 w-24 bg-gray-100 rounded-full animate-pulse"></div>
      </div>
    </div>
  </section>

  <!-- 项目列表 -->
  <section class="pb-20">
    <div class="container-custom">
      <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
        <!-- 骨架屏加载状态 -->
        {[1,2,3,4,5,6].map(() => (
          <div class="bg-white rounded-2xl overflow-hidden border border-gray-100 animate-pulse">
            <div class="aspect-video bg-gray-100"></div>
            <div class="p-6">
              <div class="h-6 bg-gray-100 rounded w-3/4 mb-2"></div>
              <div class="h-4 bg-gray-100 rounded w-full mb-1"></div>
              <div class="h-4 bg-gray-100 rounded w-2/3 mb-4"></div>
              <div class="flex gap-2">
                <div class="h-6 w-16 bg-gray-100 rounded-full"></div>
                <div class="h-6 w-20 bg-gray-100 rounded-full"></div>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- CTA 区域 -->
  <section class="py-20">
    <div class="container-custom">
      <div class="bg-white rounded-3xl border border-gray-100 shadow-card p-12 lg:p-16">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
          <div>
            <h2 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-4">
              有项目想法？
            </h2>
            <p class="text-gray-500 mb-8">
              我始终乐于讨论新项目、创意想法，或参与您的愿景。让我们一起创造一些不可思议的事物。
            </p>
            <a 
              href="/about" 
              class="inline-flex items-center gap-2 bg-dark-100 text-white px-7 py-3.5 rounded-full text-base font-medium hover:bg-dark-300 transition-all"
            >
              联系我
              <svg class="w-5 h-5 text-primary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
              </svg>
            </a>
          </div>
          <div class="flex justify-center lg:justify-end">
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-gray-50 rounded-2xl p-6 text-center">
                <div class="text-3xl font-bold text-gray-900 mb-1">50+</div>
                <p class="text-sm text-gray-500">已完成项目</p>
              </div>
              <div class="bg-gray-50 rounded-2xl p-6 text-center">
                <div class="text-3xl font-bold text-gray-900 mb-1">100%</div>
                <p class="text-sm text-gray-500">客户满意度</p>
              </div>
              <div class="bg-gray-50 rounded-2xl p-6 text-center">
                <div class="text-3xl font-bold text-gray-900 mb-1">5+</div>
                <p class="text-sm text-gray-500">年经验</p>
              </div>
              <div class="bg-primary-500/20 rounded-2xl p-6 text-center">
                <div class="text-3xl font-bold text-gray-900 mb-1">24*7</div>
                <p class="text-sm text-gray-700">支持可用</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script is:inline>
  // 使用 astro:page-load 事件确保 View Transitions 导航后也能执行
  document.addEventListener('astro:page-load', () => {
    // 只在 projects 列表页执行
    if (window.location.pathname !== '/projects' && window.location.pathname !== '/projects/') return;
    
    const SANITY_PROJECT_ID = 'k2j30muc';
    const SANITY_DATASET = 'production';
    
    let projects = [];
    let categories = [];
    let selectedCategory = '';
    let searchKeyword = '';

    const projectsGrid = document.getElementById('projects-grid');
    const categoryFilters = document.getElementById('category-filters');
    const searchInput = document.getElementById('search-input');
    
    if (!projectsGrid || !categoryFilters) return;

    // Sanity API 查询
    async function fetchSanity(query) {
      const url = `https://${SANITY_PROJECT_ID}.api.sanity.io/v2024-01-01/data/query/${SANITY_DATASET}?query=${encodeURIComponent(query)}`;
      const res = await fetch(url);
      const data = await res.json();
      return data.result;
    }

    // 生成项目卡片 HTML
    function createProjectHtml(project) {
      const cats = (project.categories || []).filter(c => c).slice(0, 2).map(c => 
        `<span class="inline-block px-2.5 py-1 bg-gray-100 rounded-full text-xs font-medium text-gray-600">${c.title}</span>`
      ).join('');
      const slugValue = project.slug?.current || project.slug;
      
      return `<a href="/projects/${slugValue}" data-astro-prefetch="hover" class="group block">
        <div class="bg-white rounded-2xl overflow-hidden border border-gray-100 hover:border-gray-200 hover:shadow-card transition-all">
          <div class="aspect-video bg-gray-50 overflow-hidden">
            ${project.thumbnail ? `<img src="${project.thumbnail}" alt="${project.title}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" loading="lazy"/>` : ''}
          </div>
          <div class="p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-2 group-hover:text-gray-600 transition-colors">${project.title}</h3>
            <p class="text-gray-500 text-sm leading-relaxed mb-4 line-clamp-2">${project.description || ''}</p>
            <div class="flex flex-wrap gap-2">${cats}</div>
          </div>
        </div>
      </a>`;
    }

    // 渲染分类筛选按钮
    function renderCategories() {
      const allCats = [{ title: '全部', slug: '' }, ...categories.filter(c => c.slug).map(c => ({ title: c.title, slug: c.slug }))];
      categoryFilters.innerHTML = allCats.map(cat => {
        const isActive = cat.slug === selectedCategory;
        return `<button data-category="${cat.slug}" class="px-4 py-2 rounded-full text-sm font-medium transition-colors ${isActive ? 'bg-dark-100 text-white' : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50'}">${cat.title}</button>`;
      }).join('');
    }

    // 筛选项目
    function filterProjects() {
      const filtered = projects.filter(p => {
        const matchCategory = !selectedCategory || p.categories?.some(c => (c.slug?.current || c.slug) === selectedCategory);
        const matchSearch = !searchKeyword || p.title.toLowerCase().includes(searchKeyword.toLowerCase());
        return matchCategory && matchSearch;
      });
      
      projectsGrid.innerHTML = filtered.length 
        ? filtered.map(createProjectHtml).join('') 
        : '<div class="col-span-full text-center py-12"><p class="text-gray-500">没有找到匹配的项目</p></div>';
    }

    // 分类筛选按钮事件
    categoryFilters.addEventListener('click', e => {
      const btn = e.target.closest('button');
      if (btn && btn.dataset.category !== undefined) {
        selectedCategory = btn.dataset.category;
        renderCategories();
        filterProjects();
      }
    });

    // 搜索功能（防抖）
    let searchTimeout;
    searchInput?.addEventListener('input', e => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchKeyword = e.target.value.trim();
        filterProjects();
      }, 300);
    });

    // 异步加载数据
    async function loadData() {
      const projectsQuery = `*[_type == "project"] | order(order asc) {
        _id, title, slug, description,
        "thumbnail": thumbnail.asset->url,
        categories[]->{title, "slug": slug.current},
        technologies, featured
      }`;
      const categoriesQuery = `*[_type == "category" && (usedFor == "projects" || usedFor == "both")] | order(title asc) { _id, title, "slug": slug.current }`;
      
      [projects, categories] = await Promise.all([fetchSanity(projectsQuery), fetchSanity(categoriesQuery)]);
      
      renderCategories();
      filterProjects();
    }

    loadData();
  });
</script>

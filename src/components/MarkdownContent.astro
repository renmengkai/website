---
// Markdown 渲染组件 - 支持代码高亮
import { marked } from 'marked';
import { codeToHtml } from 'shiki';

interface Props {
  content: string | null;
}

const { content } = Astro.props;

// 语言标签的显示名称映射
const languageLabels: Record<string, string> = {
  'javascript': 'JavaScript',
  'typescript': 'TypeScript',
  'python': 'Python',
  'java': 'Java',
  'csharp': 'C#',
  'cpp': 'C++',
  'html': 'HTML',
  'css': 'CSS',
  'json': 'JSON',
  'bash': 'Bash',
  'shell': 'Shell',
  'sh': 'Shell',
  'sql': 'SQL',
  'go': 'Go',
  'rust': 'Rust',
  'php': 'PHP',
  'ruby': 'Ruby',
  'swift': 'Swift',
  'kotlin': 'Kotlin',
  'yaml': 'YAML',
  'yml': 'YAML',
  'markdown': 'Markdown',
  'md': 'Markdown',
  'docker': 'Docker',
  'dockerfile': 'Dockerfile',
  'nginx': 'Nginx',
  'ini': 'INI',
  'conf': 'Config',
  'text': 'Plain Text',
  'plaintext': 'Plain Text',
  '': 'Plain Text'
};

// Shiki 语言映射
const shikiLangMap: Record<string, string> = {
  'javascript': 'javascript',
  'js': 'javascript',
  'typescript': 'typescript',
  'ts': 'typescript',
  'python': 'python',
  'py': 'python',
  'java': 'java',
  'csharp': 'csharp',
  'cs': 'csharp',
  'cpp': 'cpp',
  'c++': 'cpp',
  'html': 'html',
  'css': 'css',
  'json': 'json',
  'bash': 'bash',
  'shell': 'bash',
  'sh': 'bash',
  'sql': 'sql',
  'go': 'go',
  'rust': 'rust',
  'php': 'php',
  'ruby': 'ruby',
  'swift': 'swift',
  'kotlin': 'kotlin',
  'yaml': 'yaml',
  'yml': 'yaml',
  'markdown': 'markdown',
  'md': 'markdown',
  'docker': 'dockerfile',
  'dockerfile': 'dockerfile',
  'nginx': 'nginx',
  'ini': 'ini',
  'conf': 'ini',
  'text': 'text',
  'plaintext': 'text',
  '': 'text'
};

// 存储代码块，稍后处理
const codeBlocks: Array<{placeholder: string, language: string, code: string}> = [];
let codeBlockIndex = 0;

// 自定义 renderer 处理代码块
const renderer = new marked.Renderer();

// 保存原始代码块，用占位符替换
renderer.code = function({ text, lang }: { text: string, lang?: string }) {
  const placeholder = `<!--CODE_BLOCK_${codeBlockIndex}-->`;
  codeBlocks.push({
    placeholder,
    language: lang || '',
    code: text
  });
  codeBlockIndex++;
  return placeholder;
};

// 配置 marked
marked.setOptions({
  renderer,
  gfm: true,
  breaks: true
});

// 第一步：解析 Markdown（代码块用占位符）
let html = '';
if (content) {
  html = await marked.parse(content);
  
  // 第二步：处理代码块，添加高亮
  for (const block of codeBlocks) {
    const { placeholder, language, code } = block;
    const lang = language.toLowerCase();
    const displayLanguage = languageLabels[lang] || language.toUpperCase() || 'Code';
    const shikiLang = shikiLangMap[lang] || 'text';
    
    let highlightedCode = '';
    try {
      const shikiHtml = await codeToHtml(code, {
        lang: shikiLang,
        theme: 'material-theme-ocean'
      });
      // 提取 <pre> 内部的内容
      const match = shikiHtml.match(/<pre[^>]*>([\s\S]*?)<\/pre>/);
      if (match) {
        highlightedCode = match[1];
      } else {
        highlightedCode = shikiHtml;
      }
    } catch (error) {
      console.error('Shiki highlighting failed:', error);
      highlightedCode = `<code>${code
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')}</code>`;
    }
    
    // 用于复制的纯文本
    const escapedForCopy = code
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
    
    // 判断是否为 Plain Text
    const isPlainText = shikiLang === 'text';
    const preClasses = `code-block-pre !mt-0 !mb-0 !rounded-none p-4 overflow-x-auto shiki-wrapper${isPlainText ? ' plaintext-code' : ''}`;
    
    const codeBlockHtml = `<div class="code-block-wrapper my-6 group">
      <div class="code-block-container rounded-xl overflow-hidden border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow duration-200">
        <div class="code-block-header flex items-center justify-between bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-850 px-4 py-2.5 border-b border-gray-200 dark:border-gray-700">
          <div class="flex items-center gap-2">
            <span class="text-xs font-semibold text-gray-700 dark:text-gray-300">${displayLanguage}</span>
          </div>
          <button class="copy-code-btn opacity-0 group-hover:opacity-100 transition-opacity duration-200 px-3 py-1 text-xs font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white bg-white dark:bg-gray-700 rounded-md border border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-1" data-code="${escapedForCopy.replace(/"/g, '&quot;')}" title="复制代码">
            <span class="copy-text">复制</span>
            <span class="copied-text hidden">已复制!</span>
          </button>
        </div>
        <pre class="${preClasses}" style="background-color: #333333;">${highlightedCode}</pre>
      </div>
    </div>`;
    
    html = html.replace(placeholder, codeBlockHtml);
  }
} else {
  html = '<div class="text-gray-500">暂无内容</div>';
}
---

<div class="markdown-content prose prose-lg dark:prose-invert max-w-none">
  <Fragment set:html={html} />
</div>

<script>
  // 代码块复制功能
  document.addEventListener('DOMContentLoaded', () => {
    const copyButtons = document.querySelectorAll('.copy-code-btn');
    
    copyButtons.forEach(button => {
      button.addEventListener('click', async () => {
        const codeText = button.getAttribute('data-code') || '';
        const copyText = button.querySelector('.copy-text');
        const copiedText = button.querySelector('.copied-text');
        
        try {
          // 解码 HTML 实体
          const textarea = document.createElement('textarea');
          textarea.innerHTML = codeText;
          const decodedCode = textarea.value;
          
          // 复制到剪贴板
          await navigator.clipboard.writeText(decodedCode);
          
          // 显示复制成功提示
          if (copyText && copiedText) {
            copyText.classList.add('hidden');
            copiedText.classList.remove('hidden');
            
            // 2秒后恢复
            setTimeout(() => {
              copyText.classList.remove('hidden');
              copiedText.classList.add('hidden');
            }, 2000);
          }
        } catch (err) {
          console.error('复制失败:', err);
        }
      });
    });
  });
</script>

<style is:global>
  /* Markdown 内容样式 */
  .markdown-content h1 {
    @apply text-3xl font-bold mt-8 mb-4;
  }
  
  .markdown-content h2 {
    @apply text-2xl font-bold mt-8 mb-4 pb-2 border-b border-gray-200;
  }
  
  .markdown-content h3 {
    @apply text-xl font-bold mt-6 mb-3;
  }
  
  .markdown-content h4 {
    @apply text-lg font-semibold mt-4 mb-2;
  }
  
  .markdown-content p {
    @apply mb-4 leading-relaxed;
  }
  
  .markdown-content ul {
    @apply list-disc pl-6 mb-4;
  }
  
  .markdown-content ol {
    @apply list-decimal pl-6 mb-4;
  }
  
  .markdown-content li {
    @apply mb-2;
  }
  
  .markdown-content blockquote {
    @apply border-l-4 border-gray-300 pl-4 my-4 italic text-gray-600;
  }
  
  .markdown-content a {
    @apply text-primary-600 hover:underline;
  }
  
  .markdown-content code:not(pre code) {
    @apply bg-gray-100 dark:bg-gray-800 px-1.5 py-0.5 rounded text-sm font-mono;
  }
  
  .markdown-content table {
    @apply w-full border-collapse mb-4;
  }
  
  .markdown-content th,
  .markdown-content td {
    @apply border border-gray-300 dark:border-gray-600 px-4 py-2;
  }
  
  .markdown-content th {
    @apply bg-gray-100 dark:bg-gray-800 font-semibold;
  }
  
  .markdown-content hr {
    @apply my-8 border-gray-200 dark:border-gray-700;
  }
  
  .markdown-content img {
    @apply max-w-full h-auto rounded-lg my-4;
  }

  /* 代码块样式 */
  .code-block-wrapper {
    position: relative;
  }

  .code-block-pre {
    font-family: 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace !important;
  }

  /* Shiki 生成的代码块样式 */
  .shiki-wrapper code {
    display: block;
    font-family: 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace !important;
    font-variant-ligatures: normal;
    font-feature-settings: "calt" 1, "liga" 1;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    font-size: 0.875rem;
    line-height: 1.7;
  }

  /* 覆盖 Shiki 注释的内联样式 */
  .shiki-wrapper code span[style*="color:#464B5D"] {
    color: #89DDFF !important;
    font-style: italic !important;
  }

  /* Plain Text 代码块样式 - 确保文字清晰可读 */
  .shiki-wrapper code[data-lang="text"],
  .shiki-wrapper code[data-lang="plaintext"],
  .shiki-wrapper.plaintext-code code {
    color: #e0e0e0 !important;
  }

  .shiki-wrapper.plaintext-code code span {
    color: #e0e0e0 !important;
  }

  /* 滚动条美化 */
  .code-block-pre::-webkit-scrollbar {
    height: 8px;
  }

  .code-block-pre::-webkit-scrollbar-track {
    background-color: #2a2a2a;
  }

  .code-block-pre::-webkit-scrollbar-thumb {
    background-color: #555555;
    border-radius: 4px;
  }

  .code-block-pre::-webkit-scrollbar-thumb:hover {
    background-color: #777777;
  }

  /* 复制按钮动画 */
  .copy-code-btn {
    transition: all 0.2s;
  }

  .copy-code-btn:active {
    transform: scale(0.95);
  }
</style>

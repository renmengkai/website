---
// Portable Text 渲染组件
interface Block {
  _type: string;
  _key?: string;
  style?: string;
  children?: Array<{
    _type: string;
    text: string;
    marks?: string[];
  }>;
  markDefs?: Array<{
    _key: string;
    _type: string;
    href?: string;
    [key: string]: any;
  }>;
  level?: number;
  listItem?: string;
}

interface Props {
  blocks: Block[] | null;
}

const { blocks } = Astro.props;

// 渲染单个 block
function renderBlock(block: Block): string {
  if (!block || block._type !== 'block') {
    return '';
  }

  const style = block.style || 'normal';
  const children = block.children || [];

  // 渲染带有标记的文本
  function renderSpans(children: any[]): string {
    return children.map(child => {
      if (!child.text) return '';

      let text = child.text;
      const marks = child.marks || [];

      // 处理不同的标记
      for (const mark of marks) {
        if (mark === 'strong') {
          text = `<strong>${text}</strong>`;
        } else if (mark === 'em') {
          text = `<em>${text}</em>`;
        } else if (mark === 'code') {
          text = `<code>${text}</code>`;
        } else if (mark === 'underline') {
          text = `<u>${text}</u>`;
        } else if (mark === 'strike-through') {
          text = `<s>${text}</s>`;
        } else {
          // 查找 markDefs 中的链接
          const markDef = block.markDefs?.find((def: any) => def._key === mark);
          if (markDef && markDef._type === 'link' && markDef.href) {
            text = `<a href="${markDef.href}" class="text-primary-600 hover:underline">${text}</a>`;
          }
        }
      }

      return text;
    }).join('');
  }

  const content = renderSpans(children);

  // 根据样式渲染不同的 HTML 标签
  switch (style) {
    case 'h1':
      return `<h1 class="text-3xl font-bold mt-8 mb-4">${content}</h1>`;
    case 'h2':
      return `<h2 class="text-2xl font-bold mt-8 mb-4 pb-2 border-b border-gray-200">${content}</h2>`;
    case 'h3':
      return `<h3 class="text-xl font-bold mt-6 mb-3">${content}</h3>`;
    case 'h4':
      return `<h4 class="text-lg font-semibold mt-4 mb-2">${content}</h4>`;
    case 'blockquote':
      return `<blockquote class="border-l-4 border-gray-300 pl-4 my-4 italic text-gray-600">${content}</blockquote>`;
    case 'normal':
    default:
      if (content.trim()) {
        return `<p class="mb-4 leading-relaxed">${content}</p>`;
      }
      return '';
  }
}

// 渲染所有 blocks
let html = '';
if (blocks && blocks.length > 0) {
  for (const block of blocks) {
    if (block._type === 'block') {
      html += renderBlock(block);
    }
  }
} else {
  html = '<div class="text-gray-500">暂无内容</div>';
}
---

<Fragment set:html={html} />
